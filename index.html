<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Bottle Feed Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .record-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .quick-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 24px;
            border-radius: 12px;
            font-size: 22px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .quick-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .manual-section {
            padding-top: 20px;
            border-top: 2px solid #f3f4f6;
        }

        .manual-section h4 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }

        .quick-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-entry input {
            flex: 2;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .quick-entry input:focus {
            outline: none;
            border-color: #667eea;
        }

        .quick-entry button {
            flex: 1;
            background: #10b981;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .quick-entry button:active {
            background: #059669;
        }

        details {
            margin-top: 15px;
        }

        details summary {
            cursor: pointer;
            color: #667eea;
            font-size: 14px;
            padding: 10px 0;
            user-select: none;
        }

        details[open] summary {
            margin-bottom: 10px;
        }

        .advanced-inputs {
            display: grid;
            gap: 10px;
        }

        .advanced-inputs input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .advanced-inputs input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-button:active {
            background: #059669;
        }

        .status {
            text-align: center;
            color: #10b981;
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
            font-weight: 600;
        }

        .logs-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logs-header h2 {
            font-size: 20px;
            color: #333;
        }

        .clear-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .log-entry {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .log-date {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .log-details {
            color: #666;
            font-size: 18px;
        }

        .log-time {
            color: #999;
            font-size: 13px;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-style: italic;
        }

        .delete-button {
            float: right;
            background: #fee;
            color: #e44;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .stats-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçº Bottle Feed Tracker</h1>

        <div class="stats-section" id="statsSection">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">Today's Feeds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayTotal">0ml</div>
                    <div class="stat-label">Today's Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastFeed">--</div>
                    <div class="stat-label">Last Feed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgAmount">0ml</div>
                    <div class="stat-label">Avg Amount</div>
                </div>
            </div>
        </div>
        
        <div class="record-section">
            <h3>Quick Log</h3>
            
            <div class="quick-amounts">
                <button class="quick-btn" onclick="quickLog(45)">45ml</button>
                <button class="quick-btn" onclick="quickLog(70)">70ml</button>
                <button class="quick-btn" onclick="quickLog(130)">130ml</button>
                <button class="quick-btn" onclick="quickLog(180)">180ml</button>
            </div>

            <div class="manual-section">
                <h4>Manual Entry</h4>
                
                <div class="quick-entry">
                    <input type="number" id="manualAmount" placeholder="Amount (ml)" inputmode="numeric">
                    <button onclick="addQuickEntry()">Log Now</button>
                </div>

                <details>
                    <summary>Advanced: Edit Date/Time</summary>
                    <div class="advanced-inputs">
                        <input type="date" id="manualDate" placeholder="Date">
                        <input type="time" id="manualTime" placeholder="Time">
                        <button class="add-button" onclick="addManualEntry()">Add with Custom Date/Time</button>
                    </div>
                </details>
            </div>

            <div class="status" id="status"></div>
        </div>

        <div class="logs-section">
            <div class="logs-header">
                <h2>Feed Log</h2>
                <button class="clear-button" onclick="clearAllLogs()">Clear All</button>
            </div>
            <div id="logsList"></div>
        </div>
    </div>

    <script>
        // Google Sheets API endpoint
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpvWLPSczZFjlEpizpy85diLRQXrq3fag0388Glhma3VZiNDIjJBJjeD3AYXrhl2Ws/exec';
        
        // Check for incoming data from iOS Shortcut
        window.addEventListener('load', function() {
            // Check hash fragment (e.g., #voice=120ml)
            const hash = window.location.hash.substring(1); // Remove the #
            const hashParams = new URLSearchParams(hash);
            const voiceFromHash = hashParams.get('voice');
            
            // Check URL parameters (multiple possible parameter names)
            const urlParams = new URLSearchParams(window.location.search);
            const voiceFromURL = urlParams.get('voice');
            const voiceFromTrigger = urlParams.get('trigger');
            
            const voiceInput = voiceFromHash || voiceFromURL || voiceFromTrigger;

            if (voiceInput) {
                // Decode URL encoding if present
                const decodedInput = decodeURIComponent(voiceInput);
                
                // Parse the voice input
                const parsed = parseVoiceInput(decodedInput);
                if (parsed.amount) {
                    saveEntry(parsed);
                    showStatus(`‚úì Logged ${parsed.amount}ml from voice: "${decodedInput}"`);
                } else {
                    showStatus(`‚ùå Could not parse amount from: "${decodedInput}"`);
                }
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // Just loading the app - fetch existing data
                displayLogs();
                updateStats();
            }
        });

        function parseVoiceInput(text) {
            const now = new Date();
            let date = now.toISOString().split('T')[0];
            let time = now.toTimeString().split(' ')[0].substring(0, 5);
            let amount = null;

            text = text.toLowerCase();

            // Parse amount (ml, milliliters, etc.)
            const amountPatterns = [
                /(\d+)\s*(ml|milliliters?|mls)/i,
                /(\d+)\s*ounces?/i,
                /(\d+)\s*oz/i
            ];

            for (const pattern of amountPatterns) {
                const match = text.match(pattern);
                if (match) {
                    amount = parseInt(match[1]);
                    // Convert ounces to ml if needed
                    if (match[2] && (match[2].toLowerCase().includes('oz') || match[2].toLowerCase().includes('ounce'))) {
                        amount = Math.round(amount * 29.5735);
                    }
                    break;
                }
            }

            // If no explicit unit, try to extract any number (assume ml)
            if (!amount) {
                const numberMatch = text.match(/(\d+)/);
                if (numberMatch) {
                    amount = parseInt(numberMatch[1]);
                }
            }

            // Parse relative dates
            if (text.includes('yesterday')) {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                date = yesterday.toISOString().split('T')[0];
            } else if (text.includes('today')) {
                date = now.toISOString().split('T')[0];
            } else if (text.includes('tomorrow')) {
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                date = tomorrow.toISOString().split('T')[0];
            }

            // Parse specific dates (e.g., "February 10th", "Feb 10", "2/10")
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 
                              'july', 'august', 'september', 'october', 'november', 'december'];
            const monthAbbrev = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 
                               'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            // Match "February 10th" or "Feb 10"
            for (let i = 0; i < monthNames.length; i++) {
                const fullPattern = new RegExp(`${monthNames[i]}\\s+(\\d{1,2})(?:st|nd|rd|th)?`, 'i');
                const abbrPattern = new RegExp(`${monthAbbrev[i]}\\s+(\\d{1,2})(?:st|nd|rd|th)?`, 'i');
                
                let match = text.match(fullPattern) || text.match(abbrPattern);
                if (match) {
                    const day = parseInt(match[1]);
                    const year = now.getFullYear();
                    const month = (i + 1).toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    date = `${year}-${month}-${dayStr}`;
                    break;
                }
            }

            // Match "2/10" or "02/10" format
            const slashDateMatch = text.match(/(\d{1,2})\/(\d{1,2})/);
            if (slashDateMatch) {
                const month = parseInt(slashDateMatch[1]).toString().padStart(2, '0');
                const day = parseInt(slashDateMatch[2]).toString().padStart(2, '0');
                const year = now.getFullYear();
                date = `${year}-${month}-${day}`;
            }

            // Parse time patterns - try multiple approaches
            let timeFound = false;
            
            // Pattern 1: "at 3pm", "at 3:30pm", "at 3 pm"
            let match = text.match(/at\s+(\d{1,2}):?(\d{2})?\s*(am|pm|a\.m\.|p\.m\.)?/i);
            if (match) {
                let hours = parseInt(match[1]);
                let minutes = match[2] ? parseInt(match[2]) : 0;
                const period = match[3];

                if (period) {
                    const periodLower = period.toLowerCase().replace(/\./g, '');
                    if (periodLower === 'pm' && hours < 12) {
                        hours += 12;
                    } else if (periodLower === 'am' && hours === 12) {
                        hours = 0;
                    }
                }

                time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                timeFound = true;
            }

            // Pattern 2: "3:30pm", "15:30" (without "at")
            if (!timeFound) {
                match = text.match(/(\d{1,2}):(\d{2})\s*(am|pm|a\.m\.|p\.m\.)?/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    let minutes = parseInt(match[2]);
                    const period = match[3];

                    if (period) {
                        const periodLower = period.toLowerCase().replace(/\./g, '');
                        if (periodLower === 'pm' && hours < 12) {
                            hours += 12;
                        } else if (periodLower === 'am' && hours === 12) {
                            hours = 0;
                        }
                    }

                    time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    timeFound = true;
                }
            }

            // Pattern 3: "3pm", "3 pm" (just hour, no minutes)
            if (!timeFound) {
                match = text.match(/(?:^|\s)(\d{1,2})\s*(am|pm|a\.m\.|p\.m\.)(?:\s|$)/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    const period = match[2];

                    const periodLower = period.toLowerCase().replace(/\./g, '');
                    if (periodLower === 'pm' && hours < 12) {
                        hours += 12;
                    } else if (periodLower === 'am' && hours === 12) {
                        hours = 0;
                    }

                    time = `${hours.toString().padStart(2, '0')}:00`;
                    timeFound = true;
                }
            }

            // Check for "now" keyword
            if (text.includes('now') || text.includes('just now')) {
                time = now.toTimeString().split(' ')[0].substring(0, 5);
            }

            return { date, time, amount };
        }

        function quickLog(amount) {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0].substring(0, 5);
            
            saveEntry({ date, time, amount });
            showStatus(`‚úì Logged ${amount}ml`);
        }

        function addQuickEntry() {
            const amount = parseInt(document.getElementById('manualAmount').value);

            if (!amount) {
                alert('Please enter an amount');
                return;
            }

            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0].substring(0, 5);

            saveEntry({ date, time, amount });
            document.getElementById('manualAmount').value = '';
            showStatus(`‚úì Logged ${amount}ml`);
        }

        function addManualEntry() {
            const date = document.getElementById('manualDate').value;
            const time = document.getElementById('manualTime').value;
            const amount = parseInt(document.getElementById('manualAmount').value);

            if (!date || !time || !amount) {
                alert('Please fill in all fields');
                return;
            }

            saveEntry({ date, time, amount });
            
            document.getElementById('manualDate').value = '';
            document.getElementById('manualTime').value = '';
            document.getElementById('manualAmount').value = '';
            
            showStatus(`‚úì Manual entry saved!`);
        }

        function saveEntry(entry) {
            // Add to Google Sheets
            const data = {
                action: 'add',
                date: entry.date,
                time: entry.time,
                amount: entry.amount
            };
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(() => {
                // Refresh the display after saving
                setTimeout(() => {
                    displayLogs();
                    updateStats();
                }, 1000);
            }).catch(error => {
                console.error('Error saving entry:', error);
                showStatus('‚ùå Error saving feed');
            });
        }

        async function getLogs() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                
                if (data.success && data.feeds) {
                    // Sort by timestamp descending (newest first)
                    return data.feeds.sort((a, b) => {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
                }
                return [];
            } catch (error) {
                console.error('Error fetching logs:', error);
                return [];
            }
        }

        async function displayLogs() {
            const logs = await getLogs();
            const logsList = document.getElementById('logsList');

            if (logs.length === 0) {
                logsList.innerHTML = '<div class="empty-state">No feeds logged yet</div>';
                return;
            }

            logsList.innerHTML = logs.map((log, index) => `
                <div class="log-entry">
                    <button class="delete-button" onclick="deleteEntry('${log.timestamp}')">Delete</button>
                    <div class="log-date">${formatDate(log.date)}</div>
                    <div class="log-details">${log.amount} ml</div>
                    <div class="log-time">Time: ${formatTime(log.time)}</div>
                </div>
            `).join('');
        }

        function deleteEntry(timestamp) {
            if (confirm('Delete this entry?')) {
                const data = {
                    action: 'delete',
                    timestamp: timestamp
                };
                
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                }).then(() => {
                    setTimeout(() => {
                        displayLogs();
                        updateStats();
                    }, 1000);
                }).catch(error => {
                    console.error('Error deleting entry:', error);
                });
            }
        }

        async function clearAllLogs() {
            if (confirm('Are you sure you want to clear all logs? This will delete data for both you and your wife!')) {
                const logs = await getLogs();
                
                // Delete all entries
                for (const log of logs) {
                    const data = {
                        action: 'delete',
                        timestamp: log.timestamp
                    };
                    
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                }
                
                setTimeout(() => {
                    displayLogs();
                    updateStats();
                }, 1000);
            }
        }

        async function updateStats() {
            const logs = await getLogs();
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = logs.filter(log => log.date === today);

            // Today's count
            document.getElementById('todayCount').textContent = todayLogs.length;

            // Today's total
            const todayTotal = todayLogs.reduce((sum, log) => sum + parseInt(log.amount), 0);
            document.getElementById('todayTotal').textContent = todayTotal + 'ml';

            // Last feed time
            if (logs.length > 0) {
                const lastLog = logs[0];
                const lastTime = formatTime(lastLog.time);
                document.getElementById('lastFeed').textContent = lastTime;
            } else {
                document.getElementById('lastFeed').textContent = '--';
            }

            // Average amount
            if (logs.length > 0) {
                const avgAmount = Math.round(logs.reduce((sum, log) => sum + parseInt(log.amount), 0) / logs.length);
                document.getElementById('avgAmount').textContent = avgAmount + 'ml';
            } else {
                document.getElementById('avgAmount').textContent = '0ml';
            }
        }

        function showStatus(message) {
            document.getElementById('status').textContent = message;
            setTimeout(() => {
                document.getElementById('status').textContent = '';
            }, 2000);
        }

        function formatDate(dateString) {
            // Handle both ISO format (2026-02-15) and Date objects
            if (!dateString) return 'Invalid Date';
            
            let date;
            if (typeof dateString === 'string') {
                // Parse YYYY-MM-DD format
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else {
                    date = new Date(dateString);
                }
            } else {
                date = new Date(dateString);
            }
            
            if (isNaN(date.getTime())) return 'Invalid Date';
            
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatTime(timeString) {
            // Handle various time formats from Google Sheets
            if (!timeString) return 'Invalid Time';
            
            let hours, minutes;
            
            // Handle HH:MM or H:MM format
            if (typeof timeString === 'string' && timeString.includes(':')) {
                const parts = timeString.split(':');
                hours = parseInt(parts[0]);
                minutes = parseInt(parts[1]);
            } else {
                return 'Invalid Time';
            }
            
            if (isNaN(hours) || isNaN(minutes)) return 'Invalid Time';
            
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHour = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
            return `${displayHour}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function setDefaultDateTime() {
            const now = new Date();
            document.getElementById('manualDate').value = now.toISOString().split('T')[0];
            document.getElementById('manualTime').value = now.toTimeString().split(' ')[0].substring(0, 5);
        }

        // Initialize
        setDefaultDateTime();
        displayLogs();
        updateStats();
    </script>
</body>
</html>
