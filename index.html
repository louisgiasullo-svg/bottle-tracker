<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Bottle Feed Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .record-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }

        .history-table thead tr {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .history-table thead th {
            padding: 12px 10px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .history-table thead th:first-child {
            text-align: left;
            border-radius: 10px 0 0 0;
        }

        .history-table thead th:last-child {
            border-radius: 0 10px 0 0;
        }

        .history-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }

        .history-table tbody tr:last-child {
            border-bottom: none;
        }

        .history-table tbody tr:hover {
            background: #f9fafb;
        }

        .history-table tbody td {
            padding: 13px 10px;
            font-size: 15px;
            text-align: center;
            color: #374151;
        }

        .history-table tbody td:first-child {
            text-align: left;
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .history-table .total-ml {
            font-weight: 700;
            color: #374151;
            font-size: 16px;
        }

        .history-table .feed-count {
            color: #6b7280;
            font-size: 14px;
        }

        .history-empty {
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
            padding: 8px 0;
        }

        details summary {
            cursor: pointer;
            color: #667eea;
            font-size: 14px;
            padding: 10px 0;
            user-select: none;
        }

        details[open] summary {
            margin-bottom: 10px;
        }

        .advanced-inputs {
            display: grid;
            gap: 10px;
        }

        .advanced-inputs input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .advanced-inputs input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-button:active {
            background: #059669;
        }

        .status {
            text-align: center;
            color: #10b981;
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
            font-weight: 600;
        }

        .logs-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .logs-section details {
            cursor: pointer;
        }

        .logs-section details[open] summary {
            margin-bottom: 20px;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            list-style: none;
            position: relative;
        }

        .logs-header::-webkit-details-marker,
        .logs-header::marker {
            display: none;
        }

        .logs-header::before {
            content: '‚ñº';
            position: absolute;
            left: -5px;
            color: #667eea;
            font-size: 12px;
            transition: transform 0.2s;
        }

        details:not([open]) .logs-header::before {
            content: '‚ñ∂';
        }

        .logs-header h2 {
            font-size: 20px;
            color: #333;
            margin-left: 15px;
        }

        .clear-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .log-entry {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .log-date {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .log-details {
            color: #666;
            font-size: 18px;
        }

        .log-time {
            color: #999;
            font-size: 13px;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-style: italic;
        }

        .delete-button {
            float: right;
            background: #fee;
            color: #e44;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .stats-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçº Bottle Feed Tracker</h1>

        <div class="stats-section" id="statsSection">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">Today's Feeds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayTotal">0ml</div>
                    <div class="stat-label">Today's Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastFeed">--</div>
                    <div class="stat-label">Last Feed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="timeSince">--</div>
                    <div class="stat-label">Time Since Last</div>
                </div>
            </div>
        </div>
        
        <div class="record-section">
            <h3>Last 6 Days</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Feeds</th>
                        <th>Total (ml)</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr><td colspan="3" class="history-empty">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="logs-section">
            <details open>
                <summary class="logs-header">
                    <h2>Feed Log</h2>
                    <button class="clear-button" onclick="clearAllLogs()">Clear All</button>
                </summary>
                <div id="logsList"></div>
            </details>
        </div>
    </div>

    <script>
        // Google Sheets API endpoint
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpvWLPSczZFjlEpizpy85diLRQXrq3fag0388Glhma3VZiNDIjJBJjeD3AYXrhl2Ws/exec';
        
        // Check for incoming data from iOS Shortcut
        window.addEventListener('load', function() {
            // Check hash fragment (e.g., #voice=120ml)
            const hash = window.location.hash.substring(1); // Remove the #
            const hashParams = new URLSearchParams(hash);
            const voiceFromHash = hashParams.get('voice');
            
            // Check URL parameters (multiple possible parameter names)
            const urlParams = new URLSearchParams(window.location.search);
            const voiceFromURL = urlParams.get('voice');
            const voiceFromTrigger = urlParams.get('trigger');
            
            const voiceInput = voiceFromHash || voiceFromURL || voiceFromTrigger;

            if (voiceInput) {
                // Decode URL encoding if present
                const decodedInput = decodeURIComponent(voiceInput);
                
                // Parse the voice input
                const parsed = parseVoiceInput(decodedInput);
                if (parsed.amount) {
                    saveEntry(parsed);
                    showStatus(`‚úì Logged ${parsed.amount}ml from voice: "${decodedInput}"`);
                } else {
                    showStatus(`‚ùå Could not parse amount from: "${decodedInput}"`);
                }
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // Just loading the app - fetch existing data
                displayLogs();
                updateStats();
                buildHistoryTable();
            }
        });

        function parseVoiceInput(text) {
            // Get current time in EST properly
            const now = new Date();
            const estFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            const parts = estFormatter.formatToParts(now);
            const year = parts.find(p => p.type === 'year').value;
            const month = parts.find(p => p.type === 'month').value;
            const day = parts.find(p => p.type === 'day').value;
            const hour = parts.find(p => p.type === 'hour').value;
            const minute = parts.find(p => p.type === 'minute').value;
            
            let date = `${year}-${month}-${day}`;
            let time = `${hour}:${minute}`;
            let amount = null;

            text = text.toLowerCase();

            // Parse amount (ml, milliliters, etc.)
            const amountPatterns = [
                /(\d+)\s*(ml|milliliters?|mls)/i,
                /(\d+)\s*ounces?/i,
                /(\d+)\s*oz/i
            ];

            for (const pattern of amountPatterns) {
                const match = text.match(pattern);
                if (match) {
                    amount = parseInt(match[1]);
                    // Convert ounces to ml if needed
                    if (match[2] && (match[2].toLowerCase().includes('oz') || match[2].toLowerCase().includes('ounce'))) {
                        amount = Math.round(amount * 29.5735);
                    }
                    break;
                }
            }

            // If no explicit unit, try to extract any number (assume ml)
            if (!amount) {
                const numberMatch = text.match(/(\d+)/);
                if (numberMatch) {
                    amount = parseInt(numberMatch[1]);
                }
            }

            // Parse relative dates
            if (text.includes('yesterday')) {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                date = yesterday.toISOString().split('T')[0];
            } else if (text.includes('today')) {
                date = now.toISOString().split('T')[0];
            } else if (text.includes('tomorrow')) {
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                date = tomorrow.toISOString().split('T')[0];
            }

            // Parse specific dates (e.g., "February 10th", "Feb 10", "2/10")
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 
                              'july', 'august', 'september', 'october', 'november', 'december'];
            const monthAbbrev = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 
                               'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            // Match "February 10th" or "Feb 10"
            for (let i = 0; i < monthNames.length; i++) {
                const fullPattern = new RegExp(`${monthNames[i]}\\s+(\\d{1,2})(?:st|nd|rd|th)?`, 'i');
                const abbrPattern = new RegExp(`${monthAbbrev[i]}\\s+(\\d{1,2})(?:st|nd|rd|th)?`, 'i');
                
                let match = text.match(fullPattern) || text.match(abbrPattern);
                if (match) {
                    const day = parseInt(match[1]);
                    const year = now.getFullYear();
                    const month = (i + 1).toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    date = `${year}-${month}-${dayStr}`;
                    break;
                }
            }

            // Match "2/10" or "02/10" format
            const slashDateMatch = text.match(/(\d{1,2})\/(\d{1,2})/);
            if (slashDateMatch) {
                const month = parseInt(slashDateMatch[1]).toString().padStart(2, '0');
                const day = parseInt(slashDateMatch[2]).toString().padStart(2, '0');
                const year = now.getFullYear();
                date = `${year}-${month}-${day}`;
            }

            // Parse time patterns - try multiple approaches
            let timeFound = false;
            
            // Pattern 1: "at 3pm", "at 3:30pm", "at 3 pm"
            let match = text.match(/at\s+(\d{1,2}):?(\d{2})?\s*(am|pm|a\.m\.|p\.m\.)?/i);
            if (match) {
                let hours = parseInt(match[1]);
                let minutes = match[2] ? parseInt(match[2]) : 0;
                const period = match[3];

                if (period) {
                    const periodLower = period.toLowerCase().replace(/\./g, '');
                    if (periodLower === 'pm' && hours < 12) {
                        hours += 12;
                    } else if (periodLower === 'am' && hours === 12) {
                        hours = 0;
                    }
                }

                time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                timeFound = true;
            }

            // Pattern 2: "3:30pm", "15:30" (without "at")
            if (!timeFound) {
                match = text.match(/(\d{1,2}):(\d{2})\s*(am|pm|a\.m\.|p\.m\.)?/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    let minutes = parseInt(match[2]);
                    const period = match[3];

                    if (period) {
                        const periodLower = period.toLowerCase().replace(/\./g, '');
                        if (periodLower === 'pm' && hours < 12) {
                            hours += 12;
                        } else if (periodLower === 'am' && hours === 12) {
                            hours = 0;
                        }
                    }

                    time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    timeFound = true;
                }
            }

            // Pattern 3: "3pm", "3 pm" (just hour, no minutes)
            if (!timeFound) {
                match = text.match(/(?:^|\s)(\d{1,2})\s*(am|pm|a\.m\.|p\.m\.)(?:\s|$)/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    const period = match[2];

                    const periodLower = period.toLowerCase().replace(/\./g, '');
                    if (periodLower === 'pm' && hours < 12) {
                        hours += 12;
                    } else if (periodLower === 'am' && hours === 12) {
                        hours = 0;
                    }

                    time = `${hours.toString().padStart(2, '0')}:00`;
                    timeFound = true;
                }
            }

            // Check for "now" keyword
            if (text.includes('now') || text.includes('just now')) {
                time = `${hour}:${minute}`;
            }

            console.log('Parsed voice input:', { text, date, time, amount, timeFound });

            return { date, time, amount };
        }

        async function buildHistoryTable() {
            const logs = await getLogs();
            const tbody = document.getElementById('historyTableBody');

            // Get EST formatter
            const now = new Date();
            const estFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            const parts = estFormatter.formatToParts(now);
            const year = parseInt(parts.find(p => p.type === 'year').value);
            const month = parseInt(parts.find(p => p.type === 'month').value);
            const day = parseInt(parts.find(p => p.type === 'day').value);
            const currentHour = parseInt(parts.find(p => p.type === 'hour').value);

            // Calculate the start of the CURRENT 6am-6am window
            let currentWindowStart;
            if (currentHour < 6) {
                currentWindowStart = new Date(year, month - 1, day - 1, 6, 0, 0, 0);
            } else {
                currentWindowStart = new Date(year, month - 1, day, 6, 0, 0, 0);
            }

            // Build 6 previous day windows (going back from the day before current)
            const rows = [];
            for (let i = 1; i <= 6; i++) {
                const windowEnd = new Date(currentWindowStart);
                windowEnd.setDate(windowEnd.getDate() - (i - 1));
                const windowStart = new Date(windowEnd);
                windowStart.setDate(windowStart.getDate() - 1);

                // Filter logs in this window
                const windowLogs = logs.filter(log => {
                    const dateStr = log.date;
                    const timeStr = log.time;

                    let logDate = (dateStr instanceof Date) ? dateStr : new Date(dateStr);
                    if (isNaN(logDate.getTime())) return false;

                    const timeParts = timeStr.toString().replace(/'/g, '').trim().split(':');
                    const logHours = parseInt(timeParts[0]);
                    const logMinutes = parseInt(timeParts[1]) || 0;

                    const logDateTime = new Date(
                        logDate.getFullYear(),
                        logDate.getMonth(),
                        logDate.getDate(),
                        logHours,
                        logMinutes
                    );

                    return logDateTime >= windowStart && logDateTime < windowEnd;
                });

                const totalMl = windowLogs.reduce((sum, log) => sum + parseInt(log.amount), 0);
                const feedCount = windowLogs.length;

                // Label the window by its start date
                const label = windowStart.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });

                rows.push({ label, feedCount, totalMl });
            }

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="history-empty">No history yet</td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(row => `
                <tr>
                    <td>${row.label}</td>
                    <td class="feed-count">${row.feedCount}</td>
                    <td class="total-ml">${row.totalMl > 0 ? row.totalMl + ' ml' : '--'}</td>
                </tr>
            `).join('');
        }

        function addManualEntry() {
            const date = document.getElementById('manualDate').value;
            const time = document.getElementById('manualTime').value;
            const amount = parseInt(document.getElementById('manualAmount').value);

            if (!date || !time || !amount) {
                alert('Please fill in all fields');
                return;
            }

            saveEntry({ date, time, amount });
            
            document.getElementById('manualDate').value = '';
            document.getElementById('manualTime').value = '';
            document.getElementById('manualAmount').value = '';
            
            showStatus(`‚úì Manual entry saved!`);
        }

        function saveEntry(entry) {
            // Add to Google Sheets
            const data = {
                action: 'add',
                date: entry.date,
                time: entry.time,
                amount: entry.amount
            };
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(() => {
                // Refresh the display after saving
                setTimeout(() => {
                    displayLogs();
                    updateStats();
                    buildHistoryTable();
                }, 1000);
            }).catch(error => {
                console.error('Error saving entry:', error);
                showStatus('‚ùå Error saving feed');
            });
        }

        async function getLogs() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                
                if (data.success && data.feeds) {
                    // Sort by timestamp descending (newest first)
                    return data.feeds.sort((a, b) => {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
                }
                return [];
            } catch (error) {
                console.error('Error fetching logs:', error);
                return [];
            }
        }

        async function displayLogs() {
            const logs = await getLogs();
            const logsList = document.getElementById('logsList');
            
            console.log('Displaying logs:', logs);

            if (logs.length === 0) {
                logsList.innerHTML = '<div class="empty-state">No feeds logged yet</div>';
                return;
            }

            logsList.innerHTML = logs.map((log, index) => {
                console.log('Formatting log:', log);
                const formattedDate = formatDate(log.date);
                const formattedTime = formatTime(log.time);
                console.log('Formatted:', { date: formattedDate, time: formattedTime });
                
                return `
                    <div class="log-entry">
                        <button class="delete-button" onclick="deleteEntry('${log.timestamp}')">Delete</button>
                        <div class="log-date">${formattedDate}</div>
                        <div class="log-details">${log.amount} ml</div>
                        <div class="log-time">Time: ${formattedTime}</div>
                    </div>
                `;
            }).join('');
        }

        function deleteEntry(timestamp) {
            if (confirm('Delete this entry?')) {
                const data = {
                    action: 'delete',
                    timestamp: timestamp
                };
                
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                }).then(() => {
                    setTimeout(() => {
                        displayLogs();
                        updateStats();
                        buildHistoryTable();
                    }, 1000);
                }).catch(error => {
                    console.error('Error deleting entry:', error);
                });
            }
        }

        async function clearAllLogs() {
            if (confirm('Are you sure you want to clear all logs? This will delete data for both you and your wife!')) {
                const logs = await getLogs();
                
                // Delete all entries
                for (const log of logs) {
                    const data = {
                        action: 'delete',
                        timestamp: log.timestamp
                    };
                    
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                }
                
                setTimeout(() => {
                    displayLogs();
                    updateStats();
                    buildHistoryTable();
                }, 1000);
            }
        }

        async function updateStats() {
            const logs = await getLogs();
            
            // Get current time in EST properly
            const now = new Date();
            const estFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            const parts = estFormatter.formatToParts(now);
            const year = parseInt(parts.find(p => p.type === 'year').value);
            const month = parseInt(parts.find(p => p.type === 'month').value);
            const day = parseInt(parts.find(p => p.type === 'day').value);
            const currentHour = parseInt(parts.find(p => p.type === 'hour').value);
            const currentMinute = parseInt(parts.find(p => p.type === 'minute').value);
            
            // Create EST Date object for current time
            const estNow = new Date(year, month - 1, day, currentHour, currentMinute);
            
            // Determine the current "day" window (6am EST to 6am EST)
            let currentDayStart;
            if (currentHour < 6) {
                // Before 6am - use yesterday at 6am
                currentDayStart = new Date(year, month - 1, day - 1, 6, 0, 0, 0);
            } else {
                // After 6am - use today at 6am
                currentDayStart = new Date(year, month - 1, day, 6, 0, 0, 0);
            }
            
            const currentDayEnd = new Date(currentDayStart);
            currentDayEnd.setDate(currentDayEnd.getDate() + 1);
            
            console.log('Current time (EST):', estNow);
            console.log('Current day range (6am-6am EST):', currentDayStart, 'to', currentDayEnd);
            console.log('Logs:', logs);
            
            // Filter logs within the current 6am-6am window
            const todayLogs = logs.filter(log => {
                console.log('Processing log:', log);
                
                // Parse log date and time
                const dateStr = log.date;
                const timeStr = log.time;
                
                console.log('Date string:', dateStr, 'Type:', typeof dateStr);
                console.log('Time string:', timeStr, 'Type:', typeof timeStr);
                
                // Parse date - handle full GMT string or YYYY-MM-DD
                let logDate;
                if (dateStr instanceof Date) {
                    logDate = dateStr;
                } else if (typeof dateStr === 'string') {
                    // Parse the date string (handles both "Sun Feb 15 2026..." and "2026-02-15")
                    logDate = new Date(dateStr);
                }
                
                if (!logDate || isNaN(logDate.getTime())) {
                    console.error('Cannot parse date:', dateStr);
                    return false;
                }
                
                const logYear = logDate.getFullYear();
                const logMonth = logDate.getMonth();
                const logDay = logDate.getDate();
                
                // Parse time (HH:MM format, may have seconds or apostrophe)
                let timeString = timeStr.toString().replace(/'/g, '').trim();
                // Remove seconds if present (13:00:00 -> 13:00)
                const timeParts = timeString.split(':');
                const logHours = parseInt(timeParts[0]);
                const logMinutes = parseInt(timeParts[1]) || 0;
                
                console.log('Parsed:', {logYear, logMonth, logDay, logHours, logMinutes});
                
                // Create datetime object
                const logDateTime = new Date(logYear, logMonth, logDay, logHours, logMinutes);
                
                console.log('Log datetime:', logDateTime);
                console.log('Current day start:', currentDayStart);
                console.log('Current day end:', currentDayEnd);
                
                const isInRange = logDateTime >= currentDayStart && logDateTime < currentDayEnd;
                console.log('In range?', isInRange);
                return isInRange;
            });
            
            console.log('Today\'s logs (6am-6am):', todayLogs);

            // Today's count
            document.getElementById('todayCount').textContent = todayLogs.length;

            // Today's total
            const todayTotal = todayLogs.reduce((sum, log) => sum + parseInt(log.amount), 0);
            document.getElementById('todayTotal').textContent = todayTotal + 'ml';

            // Last feed time and time since last feed
            if (logs.length > 0) {
                const lastLog = logs[0];
                const lastTime = formatTime(lastLog.time);
                document.getElementById('lastFeed').textContent = lastTime;
                
                // Calculate time since last feed using EST
                const dateStr = lastLog.date;
                const timeStr = lastLog.time;
                
                console.log('Last log date:', dateStr, 'time:', timeStr);
                
                // Parse date - handle full GMT string
                let logDate;
                if (dateStr instanceof Date) {
                    logDate = dateStr;
                } else if (typeof dateStr === 'string') {
                    logDate = new Date(dateStr);
                }
                
                if (!logDate || isNaN(logDate.getTime())) {
                    console.error('Cannot parse last feed date:', dateStr);
                    document.getElementById('timeSince').textContent = '--';
                } else {
                    const logYear = logDate.getFullYear();
                    const logMonth = logDate.getMonth();
                    const logDay = logDate.getDate();
                    
                    // Parse time - handle HH:MM or HH:MM:SS
                    const timeParts = timeStr.toString().replace(/'/g, '').trim().split(':');
                    const logHours = parseInt(timeParts[0]);
                    const logMinutes = parseInt(timeParts[1]) || 0;
                    
                    const lastFeedDate = new Date(logYear, logMonth, logDay, logHours, logMinutes);
                    
                    console.log('Last feed date:', lastFeedDate, 'Now (EST):', estNow);
                    
                    const diffMs = estNow - lastFeedDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const hoursAgo = Math.floor(diffMins / 60);
                    const minutesAgo = diffMins % 60;
                    
                    console.log('Time diff:', hoursAgo, 'hours', minutesAgo, 'minutes');
                    
                    if (hoursAgo > 0) {
                        document.getElementById('timeSince').textContent = `${hoursAgo}h ${minutesAgo}m`;
                    } else {
                        document.getElementById('timeSince').textContent = `${minutesAgo}m`;
                    }
                }
            } else {
                document.getElementById('lastFeed').textContent = '--';
                document.getElementById('timeSince').textContent = '--';
            }

            // Average amount - removed, keeping for reference
            // if (logs.length > 0) {
            //     const avgAmount = Math.round(logs.reduce((sum, log) => sum + parseInt(log.amount), 0) / logs.length);
            //     document.getElementById('avgAmount').textContent = avgAmount + 'ml';
            // } else {
            //     document.getElementById('avgAmount').textContent = '0ml';
            // }
        }

        function showStatus(message) {
            document.getElementById('status').textContent = message;
            setTimeout(() => {
                document.getElementById('status').textContent = '';
            }, 2000);
        }

        function formatDate(dateString) {
            // Handle both ISO format (2026-02-15) and Date objects
            if (!dateString) return 'Invalid Date';
            
            let date;
            if (typeof dateString === 'string') {
                // Parse YYYY-MM-DD format
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else {
                    date = new Date(dateString);
                }
            } else {
                date = new Date(dateString);
            }
            
            if (isNaN(date.getTime())) return 'Invalid Date';
            
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatTime(timeString) {
            // Handle various time formats from Google Sheets
            if (!timeString) return 'Invalid Time';
            
            let hours, minutes;
            
            // Handle HH:MM or H:MM format
            if (typeof timeString === 'string' && timeString.includes(':')) {
                const parts = timeString.split(':');
                hours = parseInt(parts[0]);
                minutes = parseInt(parts[1]);
            } else {
                return 'Invalid Time';
            }
            
            if (isNaN(hours) || isNaN(minutes)) return 'Invalid Time';
            
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHour = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
            return `${displayHour}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function setDefaultDateTime() {
            const now = new Date();
            document.getElementById('manualDate').value = now.toISOString().split('T')[0];
            document.getElementById('manualTime').value = now.toTimeString().split(' ')[0].substring(0, 5);
        }

        // Initialize
        setDefaultDateTime();
        displayLogs();
        updateStats();
        buildHistoryTable();
    </script>
</body>
</html>
